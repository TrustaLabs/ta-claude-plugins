# 示例：简单功能实现的交互式计划

## 场景
用户需要为现有的用户管理系统添加一个"重置密码"功能。

## 交互流程

### 用户请求
```
用户：我需要添加一个重置密码的功能，用户可以通过邮箱重置密码。
```

### 第1轮：需求全貌挖掘

**AI 提问（使用 AskUserQuestion）：**

**问题1：核心目标与范围**
- 这个功能的主要目的是什么？是因为用户经常忘记密码，还是安全合规要求？
- 成功标准是什么？用户能够成功重置密码就够了，还是需要跟踪重置次数、防止滥用？

**问题2：用户体验流程**
- 用户如何触发重置密码？（登录页面的"忘记密码"链接？）
- 重置流程是怎样的？（发送邮件 → 点击链接 → 设置新密码？）
- 重置链接的有效期是多久？

**问题3：技术约束与边界情况**
- 是否需要验证用户身份（如安全问题、手机验证码）？
- 如果用户邮箱不存在怎么办？
- 如果用户多次请求重置怎么办？

**用户回答：**
```
- 目的：用户经常忘记密码，需要自助重置功能
- 成功标准：用户能够通过邮箱链接重置密码，链接24小时有效
- 触发方式：登录页面的"忘记密码"链接
- 流程：输入邮箱 → 发送重置邮件 → 点击链接 → 设置新密码
- 身份验证：仅通过邮箱验证，不需要额外验证
- 邮箱不存在：不显示错误（安全考虑），但不发送邮件
- 多次请求：允许，但每次请求会使之前的链接失效
```

**AI 输出 MoSCoW 范围矩阵：**

```markdown
**Must Have（必须实现）**
- [ ] 忘记密码入口（登录页面）
- [ ] 邮箱输入和验证
- [ ] 发送重置邮件功能
- [ ] 重置链接生成（24小时有效）
- [ ] 重置密码页面
- [ ] 密码强度验证

**Should Have（应该实现）**
- [ ] 重置成功后的确认邮件
- [ ] 链接失效提示

**Could Have（可以实现）**
- [ ] 重置历史记录（管理员查看）

**Won't Have（不实现）**
- [ ] 手机验证码验证
- [ ] 安全问题验证
- [ ] 防暴力破解限制（后续迭代）
```

### 第2轮：方案设计与细化

**AI 输出技术方案：**

```markdown
**技术方案**
- 使用 JWT token 作为重置链接的凭证
- Token 包含：用户ID、过期时间、随机盐值
- 邮件服务：使用现有的 EmailService
- 数据库：在 users 表添加 reset_token 和 reset_token_expires 字段

**实施步骤**

### 阶段1：后端API开发
- [ ] 创建 POST /api/auth/forgot-password 接口（文件：src/controllers/authController.ts:45）
- [ ] 创建 POST /api/auth/reset-password 接口（文件：src/controllers/authController.ts:78）
- [ ] 添加 generateResetToken() 方法（文件：src/services/userService.ts:120）
- [ ] 添加 sendResetEmail() 方法（文件：src/services/emailService.ts:56）

### 阶段2：前端页面开发
- [ ] 创建忘记密码页面（文件：src/pages/ForgotPassword.tsx）
- [ ] 创建重置密码页面（文件：src/pages/ResetPassword.tsx）
- [ ] 在登录页面添加"忘记密码"链接（文件：src/pages/Login.tsx:89）

### 阶段3：数据库迁移
- [ ] 创建数据库迁移脚本（文件：migrations/add_reset_token_fields.sql）

**边界情况矩阵**

| 维度 | 场景 | 触发条件 | 处理方案 | 优先级 |
|------|------|---------|---------|--------|
| **数据** | 邮箱不存在 | 用户输入未注册邮箱 | 显示成功消息但不发送邮件 | 高 |
| **数据** | Token过期 | 用户点击过期链接 | 显示"链接已过期，请重新申请" | 高 |
| **网络** | 邮件发送失败 | SMTP服务器错误 | 记录日志，返回通用成功消息 | 中 |
| **并发** | 多次请求重置 | 用户快速点击多次 | 防抖处理，每次请求使旧token失效 | 高 |
| **安全** | Token被猜测 | 恶意用户尝试猜测token | 使用强随机token（32字节） | 高 |
```

### 第3轮：风险测试与最终审查

**AI 输出风险评估：**

```markdown
**风险评估**

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 邮件被标记为垃圾邮件 | 中 | 配置SPF/DKIM，使用可信SMTP服务 |
| Token泄露 | 高 | 使用HTTPS，token仅使用一次 |
| 邮件服务宕机 | 中 | 添加重试机制，记录失败日志 |

**测试策略**
- 单元测试：token生成、验证逻辑（覆盖率 >80%）
- 集成测试：完整重置流程、边界情况处理
- E2E测试：用户从登录页到重置成功的完整路径

**最终完整性检查**
- [x] 所有需求都有对应实施步骤
- [x] 所有风险都有缓解措施
- [x] 所有边界情况都有处理方案
- [x] 测试策略覆盖所有关键路径
- [x] 实施顺序合理，无循环依赖
```

## 最终计划文档

保存到：`docs/plans/password-reset-feature-20250126.md`

## 关键要点

1. **3轮对话完成** - 简单功能使用3轮即可完成完整规划
2. **MoSCoW矩阵** - 明确范围，防止功能蔓延
3. **边界情况矩阵** - 系统化处理各种异常情况
4. **具体文件路径** - 每个任务都指明了具体的实施位置
